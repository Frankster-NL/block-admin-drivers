#!/usr/bin/env node
"use strict"

var http = require('http')
var shoe = require('shoe')
var request = require('superagent')
var exec = require('child_process').exec
var ecstatic = require('ecstatic')
var rpc = require('rpc-stream')
var MuxDemux = require('mux-demux')
var ansi = require('ansi-html-stream')
var program = require('commander')

program
.version(require('../package.json').version)
.option('-p, --port [port]', 'Port to listen on [port]', 9099)
.option('-v, --verbose', 'verbose output')
.parse(process.argv)

if (program.verbose) process.env.DEBUG = '*'
var log = require('debug')('driver-install')

var executable = __dirname + '/../node_modules/ninja-toolbelt/bin/ninja install'
var docs = {}
var app = http.createServer(ecstatic(__dirname + '/../public'))

app.listen(program.port, function() {
  log('listening on localhost:' + program.port)
})

var DRIVERS_URL = 'http://wiki.ninjablocks.com/drivers.json'

var sock = shoe(function (stream) {
  log('new connection')
  var mx = MuxDemux()
  request
  .get(DRIVERS_URL)
  .end(function(err, res) {
    if (err) return console.error(err)
    var drivers = mx.createStream('drivers')
    var obj = JSON.parse(res.text)
    obj.forEach(function(driver) {
      drivers.write(driver)
    })
  })

  var rpcStream = mx.createStream('rpc')
  var isInstalling = false
  var server = rpc({
    install: function(name, cb) {
      if (isInstalling) return cb(new Error('Cannot install two drivers simultaneously\n'))
      isInstalling = true
      log('installing', name)
      var logStream = mx.createStream('log')
      log('executing: ', executable + ' ' + name + ' /opt/ninja/drivers')

      var installation = exec(executable + ' ' + name + ' /opt/ninja/drivers')
      installation.on('error', function(err) {
        console.error(err)
        cb(err.toString())
      })

      installation.stdout.pipe(ansi()).pipe(logStream)
      installation.stderr.pipe(ansi()).pipe(logStream)
      if (process.verbose) {
        installation.stdout.pipe(process.stdout)
        installation.stderr.pipe(process.stderr)
      }

      installation.on('close', function(code) {
        isInstalling = false
        if (code !== 0) {
          log('Installation Failed', name)
          return cb(new Error('Installation failed!\n'))
        }
        log('Installation Success!')
        return cb(null, 'Installation Success!\n')
      })
    }
  })

  mx.pipe(stream).pipe(mx)
  rpcStream.pipe(server).pipe(rpcStream)
})

sock.install(app, '/driver-admin')
